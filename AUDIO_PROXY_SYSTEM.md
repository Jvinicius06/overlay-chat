# Sistema de Proxy de √Åudio LivePix

## üéØ Problema Resolvido

O LivePix n√£o funciona em **Safari iOS** devido a restri√ß√µes severas de iframes, cookies e WebSocket.

**Solu√ß√£o:** Servidor captura o √°udio do LivePix com Puppeteer e retransmite via SSE para os clientes.

---

## üèóÔ∏è Arquitetura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     SERVIDOR (Node.js)                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ LivePixAudioCapture (Puppeteer)                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Abre LivePix URLs em browser headless             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Intercepta requests de √°udio (MP3/WAV/OGG)        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Captura buffer de √°udio                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Converte para base64                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Emite evento 'audio'                              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ               ‚îÇ                                              ‚îÇ
‚îÇ               ‚ñº                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ AudioStreamManager (SSE)                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Gerencia conex√µes SSE dos clientes                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Recebe evento 'audio' do AudioCapture             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Broadcast audio para todos clientes               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Heartbeat para manter conex√µes vivas              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ               ‚îÇ                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ SSE Stream (/api/audio/stream)
                ‚îÇ event: audio
                ‚îÇ data: { audio: "base64...", contentType: "..." }
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     CLIENTE (mobile.js)                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  1. Conecta ao /api/audio/stream via EventSource            ‚îÇ
‚îÇ  2. Aguarda evento 'audio'                                   ‚îÇ
‚îÇ  3. Recebe base64 audio                                      ‚îÇ
‚îÇ  4. Converte base64 ‚Üí Blob ‚Üí URL                            ‚îÇ
‚îÇ  5. Cria Audio element                                       ‚îÇ
‚îÇ  6. Play() autom√°tico ‚úÖ                                     ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìÅ Arquivos Criados

### 1. `/server/src/livepix/audioCapture.js`
**Classe:** `LivePixAudioCapture`

**Responsabilidades:**
- Lan√ßa browser headless com Puppeteer
- Abre cada URL do LivePix em uma aba
- Intercepta network requests
- Captura responses de √°udio (content-type: audio/*)
- Converte buffer ‚Üí base64
- Emite evento `'audio'` com dados

**Configura√ß√£o:**
```javascript
const audioCapture = new LivePixAudioCapture(urls);

audioCapture.on('audio', (audioData) => {
  // audioData: { audio, url, contentType, size, timestamp, source }
});

await audioCapture.start();
```

**Otimiza√ß√µes:**
- Cache de 30 segundos para evitar duplicatas
- Bloqueia images/css/fonts para economizar banda
- Viewport mobile (375x667) para economizar recursos
- Browser muted (captura, n√£o reproduz)

---

### 2. `/server/src/api/audioStream.js`
**Classe:** `AudioStreamManager`

**Responsabilidades:**
- Gerencia conex√µes SSE dos clientes
- Mant√©m Map de clientes conectados
- Broadcast de √°udio para todos clientes
- Heartbeat a cada 15 segundos
- Cleanup de conex√µes stale (60s)

**Formato SSE:**
```
event: connected
data: {"clientId":1,"timestamp":123456,"message":"Audio stream connected"}

event: audio
data: {"audio":"base64...","url":"https://...","contentType":"audio/mpeg","size":12345,"timestamp":123456,"source":0}

event: heartbeat
data: {"timestamp":123456,"clients":3}
```

---

### 3. `/server/src/api/routes.js`
**Novo endpoint:**
```javascript
GET /api/audio/stream
```

Retorna: SSE stream com eventos de √°udio

---

### 4. `/server/src/index.js`
**Modifica√ß√µes:**
- Import de `AudioStreamManager` e `LivePixAudioCapture`
- Inicializa√ß√£o no `init()`
- Conecta eventos: `audioCapture.on('audio') ‚Üí audioStreamManager.broadcast()`
- Shutdown gracioso (para Puppeteer, fecha conex√µes SSE)

---

### 5. `/client/src/mobile.js`
**Modifica√ß√µes:**

**Removido:**
- `loadLivePixIframe()` (iframe approach)
- `createLivePixFloatingContainer()` (n√£o mais necess√°rio)
- L√≥gica complexa de iframe reload

**Adicionado:**
- `loadLivePixAudio()` - Inicializa SSE
- `connectAudioStream()` - EventSource connection
- `playAudioFromBase64()` - Converte base64 ‚Üí Blob ‚Üí Audio ‚Üí play()

**Funcionamento:**
```javascript
// 1. Conecta
this.audioSSE = new EventSource('/api/audio/stream');

// 2. Escuta evento 'audio'
this.audioSSE.addEventListener('audio', (e) => {
  const { audio, contentType } = JSON.parse(e.data);
  this.playAudioFromBase64(audio, contentType);
});

// 3. Play audio
const blob = new Blob([byteArray], { type: contentType });
const audioUrl = URL.createObjectURL(blob);
const audio = new Audio(audioUrl);
audio.play(); // ‚úÖ Funciona ap√≥s AudioContext unlock
```

---

## üéÆ Como Usar

### 1. Configure LivePix URLs
```bash
# server/.env
LIVEPIX_URLS=https://url1.livepix.com,https://url2.livepix.com
```

### 2. Inicie o Servidor
```bash
cd server
npm start
```

**Logs esperados:**
```
[AudioCapture] Starting Puppeteer browser...
[AudioCapture] Opening 1 LivePix page(s)...
[AudioCapture] Page loaded successfully
[AudioCapture] LivePix audio capture started
```

### 3. Abra Mobile no iOS Safari
```
http://seu-dominio.com/mobile.html
```

### 4. Clique "Toque para ativar √°udio"
Isso desbloqueia AudioContext no Safari iOS (obrigat√≥rio).

### 5. Aguarde √°udio do LivePix
Quando LivePix tocar √°udio:
```
[AudioCapture] Audio detected: https://...
[AudioCapture] Audio captured: 45678 bytes
[AudioCapture] Broadcasting audio to clients
[Mobile] Audio received: { source: 0, size: 45678, url: "..." }
[Mobile] ‚úÖ Audio playing
```

---

## ‚úÖ Vantagens

1. ‚úÖ **Funciona em QUALQUER dispositivo**
   - iOS Safari, Android Chrome, Desktop - todos funcionam!

2. ‚úÖ **Sem restri√ß√µes de iframe**
   - Servidor faz o trabalho, cliente s√≥ recebe √°udio

3. ‚úÖ **Um Puppeteer serve N clientes**
   - Escal√°vel: 1 browser headless ‚Üí broadcast para todos

4. ‚úÖ **Baixa lat√™ncia**
   - SSE √© r√°pido, √°udio chega em <1 segundo

5. ‚úÖ **Auto-reconnect**
   - Se SSE desconecta, reconecta automaticamente

6. ‚úÖ **Fallback gracioso**
   - Se Puppeteer falhar, servidor continua (s√≥ sem √°udio)

---

## ‚ö†Ô∏è Considera√ß√µes

### Recursos do Servidor

**Puppeteer consome:**
- ~100-150MB RAM por inst√¢ncia
- CPU para Chrome headless
- Banda para carregar LivePix

**Heroku Free Tier:**
- Pode n√£o suportar Puppeteer (512MB RAM)
- Use Heroku Hobby ($7/m√™s) ou superior

**Alternativas:**
- Digital Ocean Droplet ($6/m√™s)
- AWS EC2 t2.micro (free tier com 1GB RAM)
- Render.com (free tier com 512MB pode funcionar)

### Cache de √Åudio

Sistema j√° implementa cache de 30s:
```javascript
const cacheKey = this.getCacheKey(responseUrl);
if (!cached || (now - cached) > 30000) {
  // Envia √°udio
}
```

Evita enviar mesmo √°udio m√∫ltiplas vezes.

---

## üêõ Troubleshooting

### Puppeteer n√£o inicia

**Erro:** `Failed to launch the browser process`

**Solu√ß√£o:** Instale depend√™ncias do Chrome:
```bash
# Ubuntu/Debian
apt-get install -y \
  ca-certificates \
  fonts-liberation \
  libappindicator3-1 \
  libasound2 \
  libatk-bridge2.0-0 \
  libatk1.0-0 \
  libc6 \
  libcairo2 \
  libcups2 \
  libdbus-1-3 \
  libexpat1 \
  libfontconfig1 \
  libgbm1 \
  libgcc1 \
  libglib2.0-0 \
  libgtk-3-0 \
  libnspr4 \
  libnss3 \
  libpango-1.0-0 \
  libpangocairo-1.0-0 \
  libstdc++6 \
  libx11-6 \
  libx11-xcb1 \
  libxcb1 \
  libxcomposite1 \
  libxcursor1 \
  libxdamage1 \
  libxext6 \
  libxfixes3 \
  libxi6 \
  libxrandr2 \
  libxrender1 \
  libxss1 \
  libxtst6 \
  lsb-release \
  wget \
  xdg-utils
```

### √Åudio n√£o toca no iOS

**Problema:** Usu√°rio n√£o clicou no bot√£o de √°udio

**Solu√ß√£o:** Bot√£o "Toque para ativar √°udio" √© OBRIGAT√ìRIO no iOS. N√£o h√° como contornar.

### √Åudio duplicado

**Problema:** Mesmo √°udio toca m√∫ltiplas vezes

**Solu√ß√£o:** J√° implementado cache de 30s. Se ainda acontece, aumente:
```javascript
if (!cached || (now - cached) > 60000) { // 60 segundos
```

---

## üß™ Teste Local

### 1. Terminal 1 - Servidor
```bash
cd server
npm start
```

### 2. Terminal 2 - Cliente Dev
```bash
cd client
npm run dev
```

### 3. Acesse no celular
```
http://SEU_IP:5173/mobile.html
```

### 4. Simule √°udio do LivePix
Se n√£o tiver LivePix configurado, teste manualmente:
```javascript
// No console do browser (desktop)
fetch('/api/audio/stream').then(r => r.body.getReader()).then(reader => {
  reader.read().then(function processText({ done, value }) {
    console.log(new TextDecoder().decode(value));
    return reader.read().then(processText);
  });
});
```

---

## üìä Monitoramento

### Logs do Servidor
```bash
tail -f server/logs/app.log
```

### M√©tricas
Adicione endpoint de status:
```javascript
GET /api/audio/status

{
  "audioCapture": {
    "running": true,
    "urls": 1,
    "pages": 1,
    "cacheSize": 5
  },
  "audioStream": {
    "clients": 3,
    "uptime": 3600
  }
}
```

---

## üöÄ Deploy

### Heroku
```bash
git add .
git commit -m "Add audio proxy system"
git push heroku main
```

### Configurar vari√°veis:
```bash
heroku config:set LIVEPIX_URLS="https://..."
```

### Verificar logs:
```bash
heroku logs --tail
```

---

## üéâ Resultado Final

‚úÖ **iOS Safari:** Audio funciona!
‚úÖ **Android Chrome:** Audio funciona!
‚úÖ **Desktop:** Audio funciona!

Todos os dispositivos recebem √°udio via SSE, sem necessidade de iframes complexos.

**O problema do Safari iOS foi resolvido! üéä**
